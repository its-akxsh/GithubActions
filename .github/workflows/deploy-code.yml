name: Deploy to testing org on push to main

on:
    push:
        branches: [main]
        # if something is changed in this path
        paths: 
            - 'force-app/**'

jobs:
    Deploy-code-to-env:
        runs-on: ubuntu-latest
        environment: githubAction

        steps:
            - uses: actions/setup-node@v3

              with:
                node-version: '18'

            - name: 'Checkout source code'

              uses: actions/checkout@v3

              with:
                fetch-depth: '2'

            - name: 'Install SFDX'

              run: npm install @salesforce/cli --global

            - name: 'Install sfdx git delta'

              run: |
                  echo Y | sfdx plugins:install sfdx-git-delta
                  sfdx plugins
            
            - name: 'Create delta packages'

              run: |
                  mkdir changed-sources
                  sf sgd source delta --to "HEAD" --from "HEAD~1" --output changed-sources/ --generate-delta --source force-app/
                  echo "[INFO] Diff generated"

            - name: 'Deploy to env with running all local tests'

              run: |
                  echo "${{secrets.SERVER_KEY}}" > server.key
                  sf org login jwt -f server.key -i ${{ secrets.CLIENT_ID }} -o ${{secrets.USERNAME}} -r ${{vars.INSTANCE_URL}} -s
                  sf project deploy start --source-dir changed-sources/force-app --test-level RunLocalTests
